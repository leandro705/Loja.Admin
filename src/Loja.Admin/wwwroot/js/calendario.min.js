var pages = pages || {};
pages.agendamento = pages.agendamento || {};

pages.agendamento.model = function () {

    var vmEstabelecimento = function (estabelecimento) {
        var self = this;

        self.estabelecimentoId = ko.observable(estabelecimento.estabelecimentoId);
        self.nome = ko.observable(estabelecimento.nome);       
    };  

    var vmServico = function (servico) {
        var self = this;

        self.servicoId = ko.observable(servico.servicoId);
        self.nome = ko.observable(servico.nome);
    };

    var vmCliente = function (cliente) {
        var self = this;

        self.userId = ko.observable(cliente.id);
        self.nome = ko.observable(cliente.nome);
    };    

    var vmAgendamento = function (agendamento) {
        var self = this;

        self.agendamentoId = ko.observable();
        self.dataAgendamento = ko.observable();
        self.dataAgendamentoStr = ko.observable();
        self.dataAgendamentoDP = ko.observable();
        self.dataFinalAgendamento = ko.observable();        
        self.dataFinalAgendamentoStr = ko.observable();        
        self.horaInicial = ko.observable();
        self.horaFinal = ko.observable();
        self.servicoId = ko.observable();        
        self.servicoNome = ko.observable();
        self.observacao = ko.observable();
        self.dataCadastro = ko.observable();
        self.situacao = ko.observable();
        self.userId = ko.observable();
        self.usuarioNome = ko.observable();
        self.estabelecimentoId = ko.observable();
        self.estabelecimentoNome = ko.observable();               

        self.iniciar = function (agendamento) {
            let splitDataHoraInicial = agendamento.dataAgendamentoStr.split(' ');
            let splitDataHoraFinal = agendamento.dataFinalAgendamentoStr.split(' ');

            self.estabelecimentoId(agendamento.estabelecimentoId);
            self.estabelecimentoNome(agendamento.estabelecimentoNome);
            self.agendamentoId(agendamento.agendamentoId);
            self.dataAgendamentoDP(splitDataHoraInicial[0]);
            self.dataAgendamentoStr(splitDataHoraInicial[0]);
            self.dataAgendamento(agendamento.dataAgendamento);
            self.dataFinalAgendamento(agendamento.dataFinalAgendamento);
            self.dataFinalAgendamentoStr(agendamento.dataFinalAgendamentoStr);
            self.horaInicial(splitDataHoraInicial[1]);
            self.horaFinal(splitDataHoraFinal[1]);
            self.observacao(agendamento.observacao);
            self.dataCadastro(agendamento.dataCadastro);
            self.situacao(agendamento.situacao);

            setTimeout(function () {
                self.servicoId(agendamento.servicoId);
                self.servicoNome(agendamento.servicoNome);
                self.userId(agendamento.userId);
                self.usuarioNome(agendamento.usuarioNome);
            }, 500);                        
            
        };

        self.limpar = function () {
            self.agendamentoId(null);
            self.dataAgendamentoDP(null);
            self.dataAgendamentoStr(null);
            self.dataAgendamento(null);
            self.dataFinalAgendamento(null);
            self.dataFinalAgendamentoStr(null);
            self.horaInicial(null);
            self.horaFinal(null);
            self.observacao(null);
            self.servicoId(null);
            self.servicoNome(null);
            self.dataCadastro(null);
            self.situacao(null);
            self.userId(null);
            self.usuarioNome(null);
            self.estabelecimentoId(null);
            self.estabelecimentoNome(null);
        };

        if (agendamento) {
            self.iniciar(agendamento);
        }
    };    

    return {       
        vmServico,
        vmCliente,
        vmEstabelecimento,
        vmAgendamento
    };
}();
var pages = pages || {};
pages.agendamento = pages.agendamento || {};

pages.agendamento.services = function () {  

    var EPerfil = {
        ADMINISTRADOR: "Administrador",
        GERENTE: "Gerente",
        CLIENTE: "Cliente",
        FUNCIONARIO: "Funcionario"
    }; 

    var obterTodosEstabelecimentos = function () {
        var url = pages.metadata.actionUrl("/api/estabelecimentos");
        return pages.dataServices.get(url);
    }

    var obterTodosServicosPorEstabelecimentoId = function (estabelecimentoId) {
        var url = pages.metadata.actionUrl("/api/servicos?estabelecimentoId=" + estabelecimentoId);
        return pages.dataServices.get(url);
    }

    var obterTodosClientesPorEstabelecimentoId = function (estabelecimentoId) {
        var url = pages.metadata.actionUrl("/api/users/clientes?estabelecimentoId=" + estabelecimentoId);
        return pages.dataServices.get(url);
    }

    var obterTodos = function () {
        var url = pages.metadata.actionUrl("/api/agendamentos");
        return pages.dataServices.get(url);
    }

    var salvar = function (parametro) {
        var url = pages.metadata.actionUrl("/api/agendamentos");
        return pages.dataServices.postAjax(url, parametro);
    }

    var obterPorId = function (id) {
        var url = pages.metadata.actionUrl("/api/agendamentos/" + id);
        return pages.dataServices.get(url);
    }           

    var deletar = function (id) {
        var url = pages.metadata.actionUrl("/api/agendamentos/" + id);
        return pages.dataServices.deleteAjax(url);
    }  

    var atualizar = function (id, parametro) {
        var url = pages.metadata.actionUrl("/api/agendamentos/" + id);
        return pages.dataServices.putAjax(url, parametro);
    } 

    return {  
        EPerfil,
        obterTodosEstabelecimentos,
        obterTodosServicosPorEstabelecimentoId,
        obterTodosClientesPorEstabelecimentoId,
        obterTodos,
        obterPorId,
        atualizar,
        salvar,
        deletar
    };
}();
var pages = pages || {};
pages.agendamento = pages.agendamento || {};
pages.agendamento.model = pages.agendamento.model || {};
pages.agendamento.services = pages.agendamento.services || {};

pages.metadata = pages.metadata || {};
pages.dataServices = pages.dataServices || {};
pages.utils = pages.utils || {};

pages.agendamento.calendarioViewModel = function () {   
    var model = pages.agendamento.model;
    var service = pages.agendamento.services;
   
    ko.applyBindings(new function () {
        var self = this;       
        
        self.agendamentoVisualizar = ko.observable();
        self.agendamento = ko.observable(new model.vmAgendamento());
        self.estabelecimentos = ko.observableArray([]);
        self.servicos = ko.observableArray([]);
        self.servicosCadastro = ko.observableArray([]);        
        self.clientes = ko.observableArray([]);
        self.clientesCadastro = ko.observableArray([]);
        
        self.modalAgendamento = ko.observable(false);
        self.modalMensagem = ko.observable(false);
        self.modalVisualizar = ko.observable(false); 
        self.modalExcluir = ko.observable(false); 
        
        self.mensagem = ko.observable();
        self.estabelecimentoIdFiltro = ko.observable();
        self.usuarioIdFiltro = ko.observable();        
        self.calendario = ko.observable();      
        self.evento = ko.observable();
        self.bloqueiaSalvar = ko.observable(false);
        self.usuarioLogado = ko.observable(new pages.menu.model.vmUsuarioLogado(getDataToken()));

        self.exibeDropEstabelecimento = ko.computed(function () {
            if (self.usuarioLogado() &&
                (
                    self.usuarioLogado().perfil() === service.EPerfil.ADMINISTRADOR                    
                ))
                return true;

            return false;
        });

        self.exibeDropCliente = ko.computed(function () {
            if (self.usuarioLogado() &&
                (
                    self.usuarioLogado().perfil() === service.EPerfil.ADMINISTRADOR ||
                    self.usuarioLogado().perfil() === service.EPerfil.GERENTE
                ))
                return true;

            return false;
        });

        self.init = async function () {  
            if (self.usuarioLogado().isAdministrador()) {
                self.obterTodosEstabelecimentos();
                self.estabelecimentoIdFiltro.subscribe(async function (estabelecimentoId) {
                    if (!estabelecimentoId) return;                    
                    self.servicos([]);
                    self.clientes([]);

                    let servicos = await self.obterTodosServicosPorEstabelecimentoId(estabelecimentoId);
                    let clientes = await self.obterTodosClientesPorEstabelecimentoId(estabelecimentoId);
                    self.servicos(servicos);
                    self.clientes(clientes);                    
                    self.inicializarCalendario();
                });

                self.agendamento().estabelecimentoId.subscribe(async function (estabelecimentoId) {
                    if (!estabelecimentoId) return;

                    self.servicos([]);
                    self.clientesCadastro([]);

                    let servicos = await self.obterTodosServicosPorEstabelecimentoId(estabelecimentoId);
                    let clientes = await self.obterTodosClientesPorEstabelecimentoId(estabelecimentoId);
                    self.servicosCadastro(servicos);
                    self.clientesCadastro(clientes);

                });

                self.usuarioIdFiltro.subscribe(function (usuarioId) {
                    if (!usuarioId) return;
                    
                    let usuario = self.clientes().firstOrDefault(x => x.userId() === usuarioId);
                    self.agendamento().usuarioNome(usuario.nome());
                    self.inicializarCalendario();
                });

                self.agendamento().servicoId.subscribe(function (servicoId) {
                    if (!servicoId) return;

                    let servico = self.servicosCadastro().firstOrDefault(x => x.servicoId() === servicoId);
                    if (servico)
                        self.agendamento().servicoNome(servico.nome());                    
                });

                self.agendamento().userId.subscribe(function (usuarioId) {
                    if (!usuarioId) return;

                    let usuario = self.clientesCadastro().firstOrDefault(x => x.userId() === usuarioId);
                    if (usuario)
                        self.agendamento().usuarioNome(usuario.nome());                    
                });
            }
            else {                
                let servicos = await self.obterTodosServicosPorEstabelecimentoId(self.usuarioLogado().estabelecimentoId());
                self.servicos(servicos);
                self.agendamento().usuarioNome(self.usuarioLogado().nome());
            }                        
            self.inicializarCalendario();  
        };

        self.obterAgendamentoPorId = function (agendamentoId) {
            return new Promise(function (sucesso, falha) {
                pages.dataServices.bloquearTela();
                service.obterPorId(agendamentoId).then(function (result) {              
                    sucesso(result); 
                }).catch(function (mensagem) {
                    self.abrirModalMensagem(mensagem);
                    falha();
                }).finally(function () {
                    pages.dataServices.desbloquearTela();
                });
            });
        };

        self.obterTodosEstabelecimentos = function () {
            pages.dataServices.bloquearTela();
            service.obterTodosEstabelecimentos().then(function (result) {
                result.forEach(function (item) {
                    self.estabelecimentos.push(new model.vmEstabelecimento(item));
                });
            }).catch(function (mensagem) {
                self.abrirModalMensagem(mensagem);
            }).finally(function () {
                pages.dataServices.desbloquearTela();
            });
        };

        self.obterTodosClientesPorEstabelecimentoId = function (estabelecimentoId) {
            return new Promise(function (sucesso, falha) {
                var clientes = [];
                pages.dataServices.bloquearTela();
                service.obterTodosClientesPorEstabelecimentoId(estabelecimentoId).then(function (result) {
                    result.forEach(function (item) {
                        clientes.push(new model.vmCliente(item));
                    });
                    sucesso(clientes);
                }).catch(function (mensagem) {
                    console.log(mensagem);
                    falha([]);
                }).finally(function () {
                    pages.dataServices.desbloquearTela();
                });
            });
        };

        self.obterTodosServicosPorEstabelecimentoId = function (estabelecimentoId) {
            return new Promise(function (sucesso, falha) {
                var servicos = [];
                pages.dataServices.bloquearTela();
                service.obterTodosServicosPorEstabelecimentoId(estabelecimentoId).then(function (result) {
                    result.forEach(function (item) {
                        servicos.push(new model.vmServico(item));
                    });
                    sucesso(servicos);
                }).catch(function (mensagem) {
                    console.log(mensagem);
                    falha([]);
                }).finally(function () {
                    pages.dataServices.desbloquearTela();
                });
            });
        };
      
        self.inicializarCalendario = function () {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'pt-br',
                themeSystem: 'cerulean',
                bootstrapFontAwesome: false,
                allDaySlot: false,
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
                },
                views: {
                    day: {
                        titleFormat: { year: 'numeric', month: '2-digit', day: '2-digit' }
                    },
                    week: {
                        titleFormat: { year: 'numeric', month: '2-digit', day: '2-digit' }
                    }
                },
                initialView: 'dayGridMonth',
                navLinks: false,
                businessHours: false,
                editable: false,
                selectable: false,
                events:
                    function (info, successCallback, failureCallback) {
                    var parametro = {
                        inicio: info.startStr,
                        final: info.endStr,
                        estabelecimentoId: self.usuarioLogado().isAdministrador() ? self.estabelecimentoIdFiltro() : self.usuarioLogado().estabelecimentoId(),
                        usuarioId: self.usuarioLogado().isAdministrador() ? self.usuarioIdFiltro() : self.usuarioLogado().id()
                    }
                    $.get(URL_API + '/api/agendamentos/calendario', parametro, function (result, status) {
                        if (status === "success" && result.data) {
                            successCallback(
                                result.data.map(function (agendamento) {
                                    return {
                                        title: agendamento.usuarioNome + ' - ' + agendamento.servicoNome,
                                        start: agendamento.dataAgendamento,
                                        end: agendamento.dataFinalAgendamento,
                                        agendamentoId: agendamento.agendamentoId
                                    };
                                })
                            )
                        }
                    });
                },
                dateClick: function (info) { self.abrirModalAgendamento(info); },
                eventClick: function (info) { self.abrirModalEdicao(info); }
            });

            calendar.render();
            self.calendario(calendar);
        }; 

        self.abrirModalAgendamento = function (info) {   
            
            var dataAtual = new Date(new Date().toDateString());

            if (new Date(info.date) < dataAtual) {
                self.abrirModalMensagem("Selecione uma data e hora maior que atual!");
                return;
            } 
            self.bloqueiaSalvar(false);
            let dataAgendamento = pages.utils.format(info.date, 'dd/MM/yyyy');
            self.agendamento().dataAgendamentoStr(dataAgendamento);
            self.agendamento().dataAgendamentoDP(info.date);
            if (self.usuarioLogado().isAdministrador()) {
                self.agendamento().estabelecimentoId(self.estabelecimentoIdFiltro());
                self.agendamento().userId(self.usuarioIdFiltro());
            }                
            else {
                self.agendamento().estabelecimentoId(self.usuarioLogado().estabelecimentoId());
                self.agendamento().userId(self.usuarioLogado().id());
            }                
                    
            self.servicosCadastro(self.servicos());
            self.clientesCadastro(self.clientes());

            if (info.view.type == 'timeGridDay') {
                let horaInicial = pages.utils.format(info.date, 'HH:mm');
                self.agendamento().horaInicial(horaInicial);
            }

            self.modalAgendamento(true);
            
        };

        self.abrirModalEdicao = async function (info) {

            self.evento(info.event);

            let agendamento = await self.obterAgendamentoPorId(info.event.extendedProps.agendamentoId);
            var dataAtual = new Date(new Date().toDateString());

            if (new Date(agendamento.dataAgendamento) < dataAtual) {
                self.agendamentoVisualizar(new model.vmAgendamento(agendamento));   
                self.abrirModalVisualizar();
                return;
            }

            self.agendamento().iniciar(agendamento);
            self.modalAgendamento(true);
        };

        self.fecharModalAgendamento = function () {            
            self.modalAgendamento(false);
            self.bloqueiaSalvar(false);
            self.agendamento().limpar();
        };

        self.abrirModalVisualizar = function () {
            self.modalVisualizar(true);            
        };

        self.fecharModalVisualizar = function () {
            self.modalVisualizar(false);
        };

        self.abrirModalExcluir = function () {
            self.modalExcluir(true);
            self.mensagem("Confirma a exclusão do agendamento <strong>" + self.agendamento().dataAgendamentoStr() + ' ' + self.agendamento().horaInicial() + "</strong>!");
        };

        self.fecharModalExcluir = function () {
            self.modalExcluir(false);
        };

        self.abrirModalMensagem = function (mensagem) {
            self.modalMensagem(true);
            self.mensagem(mensagem);
        };

        self.fecharModalMensagem = function () {
            self.modalMensagem(false);
        };


        self.editar = function (item) {
            pages.dataServices.bloquearTela()
            window.location.href = "/Agendamento/Edicao/" + item.agendamentoId();
        };

        self.excluir = function () {
            pages.dataServices.bloquearTela();
            service.deletar(self.agendamento().agendamentoId()).then(function () {
                self.evento().remove();
                self.evento(null);
                self.fecharModalExcluir();
                self.fecharModalAgendamento();
                self.abrirModalMensagem("Agendamento excluído com sucesso!");
            }).catch(function (mensagem) {
                self.abrirModalMensagem(mensagem);
            }).finally(function () {
                pages.dataServices.desbloquearTela();
            });                
        };       

        self.validar = function () {
            var mensagens = [];

            if (isNullOrEmpty(self.agendamento().dataAgendamentoStr()))
                mensagens.push("<strong>Data Agendamento</strong> é obrigatório!");

            if (isNullOrEmpty(self.agendamento().horaInicial()))
                mensagens.push("<strong>Horário Inicial</strong> é obrigatório!");

            if (isNullOrEmpty(self.agendamento().horaFinal()))
                mensagens.push("<strong>Horário Final</strong> é obrigatório!");

            if (isNullOrEmpty(self.agendamento().servicoId()))
                mensagens.push("<strong>Serviço</strong> é obrigatório!");

            if (isNullOrEmpty(self.agendamento().userId()))
                mensagens.push("<strong>Cliente</strong> é obrigatório!");

            if (mensagens.any()) {
                self.abrirModalMensagem(mensagens.join("</br>"));
                return false;
            }
            return true;
        };

        self.salvar = function () {

            if (!self.validar()) { return; }

            var parametro = {
                dataAgendamentoStr: self.agendamento().dataAgendamentoStr() + ' ' + self.agendamento().horaInicial(),
                dataFinalAgendamentoStr: self.agendamento().dataAgendamentoStr() + ' ' + self.agendamento().horaFinal(),
                servicoId: self.agendamento().servicoId(),
                userId: self.agendamento().userId(),
                observacao: self.agendamento().observacao(),
                estabelecimentoId: self.usuarioLogado().isAdministrador() ? self.agendamento().estabelecimentoId() : self.usuarioLogado().estabelecimentoId()
            };
            
            self.bloqueiaSalvar(true);
            pages.dataServices.bloquearTela();
            service.salvar(parametro).then(function (agendamento) {

                var eventData = {
                    title: self.agendamento().usuarioNome() + ' - ' + self.agendamento().servicoNome(),
                    start: agendamento.dataAgendamento,
                    end: agendamento.dataFinalAgendamento,
                    agendamentoId: agendamento.agendamentoId
                };

                self.calendario().addEvent(eventData);
                self.fecharModalAgendamento();
                self.abrirModalMensagem("Agendamento salvo com sucesso!");
            }).catch(function (mensagem) {
                self.abrirModalMensagem(mensagem);
                self.bloqueiaSalvar(false);
            }).finally(function () {
                pages.dataServices.desbloquearTela();
            });
        };

        self.init();

    }, bindingBody);
}();